<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Emplois ‚Äî ZoneConstruction.ca</title>

  <!-- OpenLayers -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol/dist/ol.css">
  <script src="https://cdn.jsdelivr.net/npm/ol/dist/ol.js"></script>

  <style>
    :root{ --line:#eaeaea; --brand:#f9a533; --brand-2:#ffb84d; --text:#161616; --bg:#f7f7f7; }
    *{ box-sizing:border-box }
    html, body { margin:0; padding:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); color:var(--text); }

    /* Header */
    header{ position:sticky; top:0; background:#fff; border-bottom:1px solid var(--line); z-index:10 }
    nav{ max-width:1200px; margin:0 auto; display:flex; gap:22px; align-items:center; padding:14px 20px }
    nav a{ color:var(--text); text-decoration:none }
    nav a.active{ border-bottom:3px solid var(--text) }

    /* Layout */
    .container { max-width:1200px; margin:0 auto; padding:20px; }
    h1{ margin:18px 0 10px }
    .subline{ color:#666; margin:0 0 16px; font-size:.95rem }

    /* Filters */
    .filters { margin-bottom: 16px; }
    .filters h2{
      margin:0 0 10px; font-size:1.05rem;
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px; border:1px solid var(--line); background:#fafafa;
    }
    .filter-row { display:flex; gap:20px; margin-bottom:10px; }
    .filter-item { flex:1; }
    .filter-item label { font-weight:700; display:block; margin-bottom:6px; }
    .filter-item select { width:100%; padding:10px; font-size:14px; background:#fff; border:1px solid var(--line); border-radius:10px; }
    .filter-item select:focus{ outline:none; border-color:var(--brand); box-shadow:0 0 0 3px rgba(249,165,51,.25) }

    /* Main split */
    .main-container { display:flex; gap:12px; height: 600px; }
    #job-list {
      width: 32%; background: #fff; border:1px solid var(--line); border-radius:14px;
      padding: 12px; display:flex; flex-direction:column;
      box-shadow:0 1px 0 rgba(0,0,0,.02),0 8px 24px rgba(0,0,0,.03);
    }
    #map {
      width: 68%; height: 100%;
      border:1px solid var(--line); border-radius:14px; overflow:hidden;
      background:#fff;
      box-shadow:0 1px 0 rgba(0,0,0,.02),0 8px 24px rgba(0,0,0,.03);
    }

    /* Buttons */
    .btn { display:inline-block; padding:10px 14px; background:var(--brand); color:#111; border-radius:999px; text-decoration:none; font-weight:700; border:none; cursor:pointer; transition:.15s background; }
    .btn:hover{ background:var(--brand-2) }

    #get-location { margin-bottom:10px; width:100%; text-align:center; }

    /* List items */
    #job-list-items { flex:1; overflow-y:auto; }
    .job-item {
      border:1px solid var(--line); border-radius:12px; padding:10px; margin:8px 0; cursor:pointer; background:#fff;
      transition: box-shadow .15s, transform .05s;
    }
    .job-item:hover { background:#fff; box-shadow:0 4px 18px rgba(0,0,0,.06); transform: translateY(-1px); }
    .job-item h3 { margin:0 0 4px; font-size:15px; }
    .job-meta { color:#555; font-size:12.5px; }
    .job-actions a{ margin-right:6px; }

    /* Popup on map */
    .popup {
      background:#fff; border:1px solid var(--line); padding:10px; border-radius:10px;
      font-size:14px; line-height:1.4; max-height:240px; overflow-y:auto; width:260px;
      box-shadow:0 8px 24px rgba(0,0,0,.15);
    }

    /* Notices */
    .notice{background:#fff3cd;border:1px solid #ffe69c;padding:10px;border-radius:10px;margin-bottom:10px}
    .error{background:#fdecea;border:1px solid #f5c2c7;color:#b02a37}

    /* Small badges */
    .count-badge{
      display:inline-block; background:#fff; border:1px solid var(--line); border-radius:999px; padding:4px 10px; font-size:12px; margin-left:8px;
    }

    @media (max-width: 900px) {
      .main-container { flex-direction: column-reverse; height: auto; }
      #map { width: 100%; height: 340px; }
      #job-list { width: 100%; }
      .filter-row { flex-direction: column; }
    }
  </style>
</head>
<body>

<header>
  <nav>
    <a href="index.html">Accueil</a>
    <a href="emplois.html" class="active">Emplois</a>
    <a href="annoncer.html">Annoncer</a>
    <a href="apropos.html">√Ä propos</a>
  </nav>
</header>

<div class="container">
  <h1>Offres d‚Äôemploi <span id="job-count" class="count-badge" title="Offres visibles">‚Äî</span></h1>
  <p class="subline">Filtrez par m√©tier, niveau, r√©gion et secteur. Cliquez sur une offre pour centrer la carte.</p>

  <div id="msg" class="notice" style="display:none"></div>

  <div class="filters">
    <h2>üéõÔ∏è Filtres</h2>
    <div class="filter-row">
      <div class="filter-item">
        <label for="filter-metier">M√©tier</label>
        <select id="filter-metier"><option value="all">Tout</option></select>
      </div>
      <div class="filter-item">
        <label for="filter-niveau">Niveau</label>
        <select id="filter-niveau"><option value="all">Tout</option></select>
      </div>
    </div>
    <div class="filter-row">
      <div class="filter-item">
        <label for="filter-region">R√©gion</label>
        <select id="filter-region"><option value="all">Tout</option></select>
      </div>
      <div class="filter-item">
        <label for="filter-secteur">Secteur</label>
        <select id="filter-secteur"><option value="all">Tout</option></select>
      </div>
    </div>
  </div>

  <div class="main-container">
    <div id="job-list">
      <button id="get-location" class="btn">Emplois les plus proches</button>
      <div id="job-list-items"></div>
    </div>
    <div id="map"></div>
  </div>
</div>

<script>
  // ====== 1) URLS (garde les tiens) ======
  const mapJsonUrl = 'https://script.google.com/macros/s/AKfycbzfEPL-RwaT_mBSeI7RGQrWZ1OY14ip13r-AonSrpB6puAjyEg3wSGWhN9lct0fHZB2iQ/exec?view=map';
  const googleJobsJsonUrl = 'https://script.google.com/macros/s/AKfycbzfEPL-RwaT_mBSeI7RGQrWZ1OY14ip13r-AonSrpB6puAjyEg3wSGWhN9lct0fHZB2iQ/exec';

  // ====== 2) Helpers ======
  const qs = new URLSearchParams(location.search);
  const $ = sel => document.querySelector(sel);
  function msg(text, type='notice'){
    const m=$('#msg'); m.textContent=text;
    m.className= type==='error'?'notice error':'notice';
    m.style.display='block';
  }

  // ====== 3) Carte OpenLayers ======
  let jobsArray = [];
  const map = new ol.Map({
    target: 'map',
    layers: [new ol.layer.Tile({ source: new ol.source.OSM() })],
    view: new ol.View({ center: ol.proj.fromLonLat([-73.5673, 45.5017]), zoom: 12 }),
    controls: []
  });

  const markerStyle = new ol.style.Style({
    image: new ol.style.Icon({ anchor: [0.5, 1], src: 'https://maps.google.com/mapfiles/ms/icons/orange-dot.png', scale: 1 })
  });

  const vectorSource = new ol.source.Vector({});
  const markersLayer = new ol.layer.Vector({ source: vectorSource });
  map.addLayer(markersLayer);

  const popupContainer = document.createElement('div');
  popupContainer.className = 'popup';
  const popupOverlay = new ol.Overlay({ element: popupContainer, positioning: 'bottom-center', offset: [0, -10] });
  map.addOverlay(popupOverlay);

  map.on('click', evt => {
    const feature = map.forEachFeatureAtPixel(evt.pixel, f => f);
    if (feature) {
      popupContainer.innerHTML = feature.get('details');
      popupOverlay.setPosition(feature.getGeometry().getCoordinates());
    } else {
      popupOverlay.setPosition(undefined);
    }
  });

  function haversineDistance(lat1, lon1, lat2, lon2) {
    const R = 6371, toRad = x => x * Math.PI / 180;
    const dLat = toRad(lat2 - lat1), dLon = toRad(lon2 - lon1);
    const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
    return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  }

  function populateFilter(id, values) {
    const select = document.getElementById(id);
    select.innerHTML = '<option value="all">Tout</option>';
    [...values].sort((a,b)=>a.localeCompare(b,'fr',{sensitivity:'base'})).forEach(val => {
      if(!val) return;
      const opt = document.createElement('option');
      opt.value = val.trim().toLowerCase();
      opt.textContent = val.trim();
      select.appendChild(opt);
    });
  }

  function updateCount(n){
    const el = document.getElementById('job-count');
    el.textContent = n === 0 ? '0 offre' : (n === 1 ? '1 offre' : `${n} offres`);
  }

  function applyFilters() {
    const metier = document.getElementById('filter-metier').value;
    const niveau = document.getElementById('filter-niveau').value;
    const region = document.getElementById('filter-region').value;
    const secteur = document.getElementById('filter-secteur').value;

    // sync URL
    const p = new URLSearchParams();
    if(metier!=='all')  p.set('metier',metier);
    if(niveau!=='all')  p.set('niveau',niveau);
    if(region!=='all')  p.set('region',region);
    if(secteur!=='all') p.set('secteur',secteur);
    const newUrl = location.pathname + (p.toString()?('?'+p.toString()):'');
    history.replaceState(null,'',newUrl);

    vectorSource.clear();
    const list = $('#job-list-items');
    list.innerHTML = '';
    let visible = 0;

    jobsArray.forEach(job => {
      const d = job.data;
      const match =
        (metier === 'all' || (d["Job Category"] || "").toLowerCase().includes(metier)) &&
        (niveau === 'all' || (d["qualifications"] || "").toLowerCase().includes(niveau)) &&
        (region === 'all' || (d["Region"] || "").toLowerCase().includes(region)) &&
        (secteur === 'all' || (d["Secteur"] || "").toLowerCase().includes(secteur));

      if (match) {
        visible++;
        vectorSource.addFeature(job.feature);
        const div = document.createElement('div');
        div.className = 'job-item';
        const distanceText = job.distance !== null ? ` ¬∑ ${job.distance.toFixed(1)} km` : '';

        // salaire (fallback)
        let salary = d["Salary Display"] || '';
        if (!salary && (d["Min Salary"] || d["Max Salary"])) {
          const min = d["Min Salary"], max = d["Max Salary"], currency = d["Currency"] || "CAD", unit = (d["Salary Unit"] || "").toLowerCase();
          if (min && max)      salary = `${min} ‚Äì ${max} ${currency} / ${unit}`;
          else if (min)        salary = `√Ä partir de ${min} ${currency} / ${unit}`;
          else if (max)        salary = `Jusqu‚Äô√† ${max} ${currency} / ${unit}`;
        }

        const cats = [d["Job Category"], d["qualifications"], d["Region"], d["Secteur"]].filter(Boolean).join(", ");

        div.innerHTML = `
          <div style="display:flex; align-items:flex-start; gap:10px;">
            ${d["Logo URL"] ? `<img src="${d["Logo URL"]}" style="max-height:40px; max-width:40px; object-fit:contain; border-radius:8px; border:1px solid var(--line);">` : ""}
            <div>
              <h3>${d["Job Title"] || d["Company Name"] || "Offre"}</h3>
              <div class="job-meta">${d["Company Name"] || ""}${distanceText}</div>
            </div>
          </div>
          <div style="font-size:13px; margin-top:8px;">
            ${cats ? `<div><strong>Cat√©gories:</strong> ${cats}</div>` : ""}
            ${salary ? `<div><strong>Salaire:</strong> ${salary}</div>` : ""}
            ${d["City"] ? `<div><strong>Lieu:</strong> ${d["City"]}${d["addressRegion"] ? ', '+d["addressRegion"] : ''}</div>` : ""}
          </div>
          <div class="job-actions" style="margin-top:8px;">
            ${d["email"] ? `<a href="mailto:${(d["email"]||'').trim()}" class="btn">üìß Postuler</a>` : ""}
            ${d["Company Website"] ? `<a href="${d["Company Website"]}" class="btn" target="_blank" rel="noopener">üåê Site</a>` : ""}
          </div>
        `;

        div.addEventListener('click', () => {
          popupContainer.innerHTML = job.feature.get('details');
          popupOverlay.setPosition(job.feature.getGeometry().getCoordinates());
          map.getView().animate({ center: job.feature.getGeometry().getCoordinates(), zoom: 14 });
        });

        list.appendChild(div);
      }
    });

    updateCount(visible);
  }

  async function addMarkers() {
    try{
      const res = await fetch(mapJsonUrl, {cache:'no-store'});
      if(!res.ok) throw new Error('API indisponible');
      const data = await res.json();
      if (!Array.isArray(data)) throw new Error('Format inattendu');

      const metiers = new Set(), niveaux = new Set(), regions = new Set(), secteurs = new Set();

      data.forEach(job => {
        if (!job.Latitude || !job.Longitude) return;

        let salary = job["Salary Display"] || '';
        if (!salary && (job["Min Salary"] || job["Max Salary"])) {
          const min = job["Min Salary"], max = job["Max Salary"], currency = job["Currency"] || "CAD", unit = (job["Salary Unit"] || "").toLowerCase();
          if (min && max)      salary = `${min} ‚Äì ${max} ${currency} / ${unit}`;
          else if (min)        salary = `√Ä partir de ${min} ${currency} / ${unit}`;
          else if (max)        salary = `Jusqu‚Äô√† ${max} ${currency} / ${unit}`;
        }
        const categories = [job["Job Category"], job["qualifications"], job["Region"], job["Secteur"]].filter(Boolean).join(', ');

        const html = `
          <div style="display:flex; align-items:flex-start; gap:10px;">
            ${job["Logo URL"] ? `<img src="${job["Logo URL"]}" alt="Logo" style="max-width:50px; max-height:50px; object-fit:contain; border-radius:8px; border:1px solid var(--line);">` : ""}
            <div>
              <h3 style="margin:0;">${job["Job Title"] || job["Company Name"] || "Offre"}</h3>
              <div style="font-size:12.5px;color:#555">${job["Company Name"] || ""}</div>
            </div>
          </div>
          <div style="font-size:13px; margin-top:8px;">
            ${categories ? `<div><strong>Cat√©gories:</strong> ${categories}</div>` : ""}
            ${salary ? `<div><strong>Salaire:</strong> ${salary}</div>` : ""}
            ${job["City"] ? `<div><strong>Lieu:</strong> ${job["City"]}${job["addressRegion"] ? ', '+job["addressRegion"] : ''}</div>` : ""}
            <div style="margin-top:6px">
              ${job["email"] ? `<a href="mailto:${(job["email"]||'').trim()}" class="btn">üìß Postuler</a>` : ""}
              ${job["Company Website"] ? `<a href="${job["Company Website"]}" target="_blank" rel="noopener" class="btn" style="margin-left:6px">üåê Site</a>` : ""}
            </div>
          </div>
        `;

        const feature = new ol.Feature({
          geometry: new ol.geom.Point(ol.proj.fromLonLat([parseFloat(job.Longitude), parseFloat(job.Latitude)]))
        });
        feature.set('details', html);
        feature.setStyle(markerStyle);
        vectorSource.addFeature(feature);

        jobsArray.push({ data: job, feature, distance: null });

        (job["Job Category"] || "").split(',').forEach(v => { const t=v.trim(); if(t) metiers.add(t); });
        (job["qualifications"] || "").split(',').forEach(v => { const t=v.trim(); if(t) niveaux.add(t); });
        (job["Region"] || "").split(',').forEach(v => { const t=v.trim(); if(t) regions.add(t); });
        (job["Secteur"] || "").split(',').forEach(v => { const t=v.trim(); if(t) secteurs.add(t); });
      });

      populateFilter('filter-metier', metiers);
      populateFilter('filter-niveau', niveaux);
      populateFilter('filter-region', regions);
      populateFilter('filter-secteur', secteurs);

      // URL preset (?metier=..., etc.)
      ['metier','niveau','region','secteur'].forEach(k=>{
        const v = (qs.get(k)||'').toLowerCase();
        if(v) { const sel = document.getElementById('filter-'+k); if (sel) sel.value = v; }
      });

      applyFilters();
    }catch(err){
      console.error(err);
      msg("Impossible de charger les offres pour le moment.", 'error');
    }
  }

  // Tri par proximit√©
  document.getElementById('get-location').addEventListener('click', () => {
    if (!navigator.geolocation) return alert("G√©olocalisation non support√©e.");
    navigator.geolocation.getCurrentPosition(pos => {
      const { latitude, longitude } = pos.coords;
      jobsArray.forEach(job => {
        if (job.data.Latitude && job.data.Longitude) {
          job.distance = haversineDistance(latitude, longitude, parseFloat(job.data.Latitude), parseFloat(job.data.Longitude));
        } else {
          job.distance = null;
        }
      });
      jobsArray.sort((a, b) => (a.distance ?? 1e9) - (b.distance ?? 1e9));
      applyFilters();
      map.getView().animate({center: ol.proj.fromLonLat([longitude, latitude]), zoom: 12});
    }, ()=>alert("Impossible d‚Äôobtenir votre position."));
  });

  ['metier', 'niveau', 'region', 'secteur'].forEach(f => {
    document.getElementById(`filter-${f}`).addEventListener('change', applyFilters);
  });

  // JSON-LD (optionnel)
  async function loadGoogleJobsStructuredData() {
    try{
      const res = await fetch(googleJobsJsonUrl, {cache:'no-store'});
      const jobs = await res.json();
      if (Array.isArray(jobs)) {
        jobs.forEach(job => {
          const script = document.createElement('script');
          script.type = 'application/ld+json';
          script.text = JSON.stringify(job);
          document.head.appendChild(script);
        });
      }
    }catch(e){ /* silencieux */ }
  }

  addMarkers();
  loadGoogleJobsStructuredData();
</script>

</body>
</html>

