<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Annoncer — ZoneConstruction.ca</title>
  <meta name="description" content="Publiez une offre d’emploi en construction au Québec. Paiement sécurisé via Stripe, publication automatisée.">
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 img-src 'self' data: https:;
                 script-src 'self' 'unsafe-inline';
                 style-src 'self' 'unsafe-inline' https:;
                 connect-src 'self' https://script.google.com;
                 frame-ancestors 'none';
                 base-uri 'self'">

  <style>
    :root{--line:#eaeaea;--brand:#f9a533;--brand-2:#ffb84d;--text:#161616;--muted:#666;--bg:#fff}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
    header{border-bottom:1px solid var(--line);background:#fff}
    nav{max-width:1100px;margin:0 auto;padding:14px 20px;display:flex;gap:22px}
    nav a{text-decoration:none;color:#111}
    nav a.active{border-bottom:3px solid #111}

    .wrap{max-width:900px;margin:0 auto;padding:20px}
    h1{margin:8px 0 14px}
    .notice{background:#fff3cd;border:1px solid #ffe69c;padding:10px;border-radius:8px;margin:8px 0}

    .section{margin:24px 0}
    .section h2{margin:0 0 10px;font-size:1.05rem;font-weight:600;padding-bottom:6px;border-bottom:1px solid var(--line)}
    .card{border:1px solid var(--line);border-radius:14px;padding:18px;background:#fff;margin:12px 0;box-shadow:0 1px 0 rgba(0,0,0,.02),0 8px 24px rgba(0,0,0,.03)}
    label{font-weight:700;display:block;margin-bottom:6px}
    .muted{color:var(--muted);font-size:.9rem}
    .req::after{content:" *";color:#b00020}

    input,textarea,select{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;font:inherit;background:#fff}
    textarea{min-height:140px;resize:vertical}
    input:focus,textarea:focus,select:focus{outline:none;border-color:var(--brand);box-shadow:0 0 0 3px rgba(249,165,51,.25)}

    .grid{display:grid;gap:16px}
    .grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}

    .logo-preview{display:flex;align-items:center;gap:12px;margin-top:8px}
    .logo-preview img{max-height:48px;border-radius:8px;border:1px solid var(--line)}
    .btn{display:inline-block;background:var(--brand);color:#111;border:none;border-radius:999px;padding:12px 16px;font-weight:700;text-decoration:none;cursor:pointer;transition:.15s background}
    .btn:hover{background:var(--brand-2)}
    .btn[disabled]{opacity:.6;cursor:default}
    footer{border-top:1px solid #ddd;margin-top:40px;padding:20px;text-align:center;font-size:0.9rem}
    .hidden{display:none}

    /* Comment postuler — FIXED, responsive & unclipped */
.apply-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit, minmax(180px,1fr));
  gap:12px;
  align-items:stretch;
  margin-top:10px;
}

.chip{
  display:flex;
  align-items:center;
  gap:10px;
  border:1px solid var(--line);
  border-radius:999px;
  padding:12px 14px;
  background:#fff;
  line-height:1.25;
  font-weight:600;
  overflow:hidden;
}

.chip input{
  margin:0;
  flex:0 0 auto;
}

.chip span{
  flex:1 1 auto;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}

@media (max-width:640px){
  .apply-grid{ grid-template-columns:repeat(2, minmax(0,1fr)); }
  .chip span{ white-space:normal; }
}

.chip:has(input:checked){
  border-color: var(--brand);
  box-shadow: 0 0 0 3px rgba(249,165,51,.15);
}

  </style>
</head>
<body>
  <header>
    <nav>
      <a href="index.html">Accueil</a>
      <a href="emplois.html">Emplois</a>
      <a class="active" href="annoncer.html">Annoncer</a>
      <a href="apropos.html">À propos</a>
    </nav>
  </header>

  <div class="wrap">
    <h1>Publier une offre</h1>
    <p class="notice">Répondez d’abord à la question CCQ. Les autres champs apparaîtront ensuite.</p>

    <div class="card">
      <form id="jobForm" class="grid" novalidate>
        <!-- SECTION: Question CCQ ONLY (visible au départ) -->
        <div class="section">
          <h2>Carte de compétence CCQ</h2>
          <label class="req">Carte de compétence CCQ requise ?</label>
          <div style="display:flex;gap:16px;margin-top:6px">
            <label><input type="radio" name="ccq_required" value="OUI" required> Oui</label>
            <label><input type="radio" name="ccq_required" value="NON" required> Non</label>
          </div>
        </div>

        <!-- TOUT LE RESTE — masqué tant que la question n’est pas répondue -->
        <div id="afterCcq" class="hidden">
          <!-- CCQ = NON → Catégorie générale -->
          <div id="wrapCategorie" class="section hidden">
            <h2>Catégorie</h2>
            <label class="req" for="categorie">Catégorie</label>
            <select id="categorie" name="Categorie">
              <option value="" disabled selected>— Sélectionner —</option>
              <option>Administration</option>
              <option>Vente</option>
              <option>Chantier</option>
            </select>
          </div>

          <!-- CCQ = OUI → 4 sélecteurs CCQ -->
          <div id="wrapMetier" class="section hidden">
            <h2>Métier / Occupation</h2>
            <label class="req" for="metier" class="sr-only">Métier</label>
            <select id="metier" name="Metier">
              <option value="" disabled selected>— Sélectionner —</option>
              <option>Arpenteur/Arpenteuse</option>
              <option>Briqueteur-maçon/Briqueteuse-maçonne</option>
              <option>Charpentier-menuisier/Charpentière-menuisière</option>
              <option>Électricien/Électricienne</option>
              <option>Plâtrier/Plâtrière</option>
              <option>Soudeur/Soudeuse</option>
              <option>Tuyauteur/Tuyauteuse</option>
            </select>
          </div>

          <div id="wrapNiveau" class="section hidden">
            <h2>Niveau</h2>
            <label class="req" for="niveau" class="sr-only">Niveau</label>
            <select id="niveau" name="Niveau">
              <option value="" disabled selected>— Sélectionner —</option>
              <option>Compagnon</option>
              <option>Apprenti</option>
              <option>Occupation</option>
            </select>
          </div>

          <div id="wrapSecteur" class="section hidden">
            <h2>Secteur</h2>
            <label class="req" for="secteur" class="sr-only">Secteur</label>
            <select id="secteur" name="Secteur">
              <option value="" disabled selected>— Sélectionner —</option>
              <option>Génie Civil et Voirie</option>
              <option>Industriel</option>
              <option>Institutionnel et Commercial</option>
              <option>Résidentiel</option>
            </select>
          </div>

          <div id="wrapRegion" class="section hidden">
            <h2>Région</h2>
            <label class="req" for="region" class="sr-only">Région</label>
            <select id="region" name="Region">
              <option value="" disabled selected>— Sélectionner —</option>
              <option>01 Îles-de-la-Madeleine</option>
              <option>02 Bas-Saint-Laurent–Gaspésie</option>
              <option>03 Saguenay–Lac-Saint-Jean</option>
              <option>04 Québec</option>
              <option>06 Mauricie–Bois-Francs</option>
              <option>07 Estrie</option>
              <option>08 Grand Montréal</option>
              <option>09 Outaouais</option>
              <option>10 Abitibi-Témiscamingue</option>
              <option>11 Côte-Nord</option>
              <option>13 Baie-James</option>
              <option>14 Nunavik</option>
            </select>
          </div>

          <!-- Détails du poste -->
          <div class="section">
            <h2>Détails du poste</h2>

            <!-- visibles seulement si CCQ = NON -->
            <div id="wrapTitle" class="hidden">
              <label class="req" for="titre">Titre du poste</label>
              <input id="titre" name="Job Title" placeholder="Ex: Adjoint administratif, Charpentier-menuisier" />
            </div>

            <div>
              <label class="req" for="description">Description</label>
              <textarea id="description" name="Job Description" required></textarea>
            </div>

            <div class="grid grid-2">
              <div>
                <label class="req" for="horaire">Horaire</label>
                <select id="horaire" name="Employment Type" required>
                  <option value="" disabled selected>— Sélectionner —</option>
                  <option>Temps-Plein</option>
                  <option>Temps-Partiel</option>
                  <option>Contractuel</option>
                  <option>Rotation Fly-in Fly-out</option>
                  <option>Horaire varié</option>
                  <option>Travail à distance</option>
                  <option>Indépendant</option>
                  <option>Autre arrangement</option>
                </select>
              </div>

              <div id="wrapSalaire" class="hidden">
                <label for="salaire">Salaire</label>
                <input id="salaire" name="Salary Display" placeholder="ex: 35–40 $/h" />
                <div class="muted">Affiché aussi sur la fiche (Google Jobs).</div>
              </div>
            </div>
          </div>

          <!-- Localisation -->
          <div class="section">
            <h2>Localisation</h2>
            <div class="grid grid-2">
              <div><label class="req" for="street">Numéro et rue</label><input id="street" name="Street Address" required /></div>
              <div><label class="req" for="city">Ville</label><input id="city" name="City" required /></div>
            </div>
            <div class="grid grid-2">
              <div><label class="req" for="postal">Code postal</label><input id="postal" name="Postal Code" required placeholder="H2X 1Y4" pattern="[A-Za-z]\\d[A-Za-z][ -]?\\d[A-Za-z]\\d" title="Format A1A 1A1" /></div>
              <div><label class="req" for="prov">Province</label><input id="prov" name="addressRegion" required value="QC" /></div>
            </div>
            <div><label class="req" for="country">Pays</label><input id="country" name="Country" required value="Canada" /></div>
          </div>

          <!-- Entreprise & contact -->
          <div class="section">
            <h2>Entreprise et contact</h2>
            <div><label class="req" for="company">Nom de l'entreprise</label><input id="company" name="Company Name" required /></div>
            <div>
              <label for="logo">Logo de l'entreprise</label>
              <input id="logo" type="file" name="Logo File" accept="image/*" />
              <div id="logoPreview" class="logo-preview hidden">
                <img id="logoImg" alt="Logo preview" />
                <button id="logoClear" type="button" class="btn" style="padding:6px 10px">Retirer</button>
              </div>
              <div class="muted">PNG/JPG (facultatif). Un aperçu s’affichera après sélection.</div>
            </div>
            <div class="grid grid-2">
              <div><label class="req" for="email">Courriel de communication</label><input id="email" type="email" name="email" required placeholder="contact@entreprise.com" /></div>
              <div><label for="phone">Téléphone</label><input id="phone" name="Phone" placeholder="514-123-4567" /></div>
            </div>
            <div><label for="website">Site Web</label><input id="website" name="Company Website" placeholder="https://..." /></div>
          </div>

<!-- SECTION: Comment postuler -->
<div class="section">
  <h2>Comment postuler</h2>

  <fieldset style="border:0;padding:0;margin:0">
    <legend class="muted" style="position:absolute;left:-9999px">Méthodes de candidature</legend>

    <div class="apply-grid">
      <label class="chip">
        <input type="checkbox" name="apply_methods" value="Courriel" />
        <span>Courriel</span>
      </label>

      <label class="chip">
        <input type="checkbox" name="apply_methods" value="En personne" />
        <span>En personne</span>
      </label>

      <label class="chip">
        <input type="checkbox" name="apply_methods" value="Téléphone/SMS" />
        <span>Téléphone / SMS</span>
      </label>

      <label class="chip">
        <input type="checkbox" name="apply_methods" value="Site Web" />
        <span>Site Web</span>
      </label>
    </div>
  </fieldset>

  <div class="muted" style="margin-top:8px">Vous pouvez choisir plusieurs options.</div>
</div>

          <!-- Honeypot anti-bot -->
          <input type="text" name="website_hp" autocomplete="off" tabindex="-1" style="position:absolute;left:-9999px;top:-9999px" aria-hidden="true">

          <!-- TECH -->
          <input type="hidden" name="allow_geocode" value="1">
          <button class="btn" id="submitBtn" type="submit">Continuer au paiement</button>
        </div><!-- /#afterCcq -->
      </form>
    </div>
  </div>

  <footer>
    <p>&copy; 2025 ZoneConstruction.ca |
      <a href="politique.html">Politique de confidentialité</a> |
      <a href="conditions.html">Conditions d’utilisation</a>
    </p>
  </footer>

  <script>
    // WRITE endpoint (Apps Script)
    const API = 'https://script.google.com/macros/s/AKfycbyJ5_OeEPlq4z-2QPaP2IzRBRtz1Gs-p0uMxhNoZBx2jeKbclovTCKb-F1twt0xXZEzdA/exec';

    // Helpers
    const addHidden = el => el.classList.add('hidden');
    const remHidden = el => el.classList.remove('hidden');
    const isHidden  = el => !el || el.classList.contains('hidden') || el.offsetParent === null;

    // CCQ radios + wrapper that contains everything else
    const radiosCcq  = document.querySelectorAll('input[name="ccq_required"]');
    const afterCcq   = document.getElementById('afterCcq');

    // General category (shown only if NON)
    const wrapCategorie = document.getElementById('wrapCategorie');
    const categorie     = document.getElementById('categorie');

    // 4 CCQ selectors (shown only if OUI)
    const wrapMetier  = document.getElementById('wrapMetier');
    const wrapNiveau  = document.getElementById('wrapNiveau');
    const wrapSecteur = document.getElementById('wrapSecteur');
    const wrapRegion  = document.getElementById('wrapRegion');
    const metier  = document.getElementById('metier');
    const niveau  = document.getElementById('niveau');
    const secteur = document.getElementById('secteur');
    const region  = document.getElementById('region');

    // Title/Salary (shown only if NON)
    const wrapTitle   = document.getElementById('wrapTitle');
    const wrapSalaire = document.getElementById('wrapSalaire');
    const titre   = document.getElementById('titre');
    const salaire = document.getElementById('salaire');

    function updateCcqUI(){
      const selected = document.querySelector('input[name="ccq_required"]:checked');

      if(!selected){
        addHidden(afterCcq);
        return;
      }

      // once answered, reveal the rest of the form
      remHidden(afterCcq);

      const ccqOui = selected.value === 'OUI';

      if (ccqOui){
        // CCQ = OUI → CCQ selects required & visible; hide general category and title/salary
        addHidden(wrapCategorie);
        categorie?.removeAttribute('required'); if (categorie) categorie.selectedIndex = 0;

        [wrapMetier,wrapNiveau,wrapSecteur,wrapRegion].forEach(remHidden);
        [metier,niveau,secteur,region].forEach(el => el?.setAttribute('required','required'));

        addHidden(wrapTitle); addHidden(wrapSalaire);
        titre?.removeAttribute('required'); if (titre) titre.value = '';
      }else{
        // CCQ = NON → show general category + title/salary; hide CCQ selects
        remHidden(wrapCategorie);
        categorie?.setAttribute('required','required');

        [wrapMetier,wrapNiveau,wrapSecteur,wrapRegion].forEach(addHidden);
        [metier,niveau,secteur,region].forEach(el => { if(el){ el.removeAttribute('required'); el.selectedIndex = 0; } });

        remHidden(wrapTitle); remHidden(wrapSalaire);
        titre?.setAttribute('required','required');
      }
    }

    radiosCcq.forEach(r => r.addEventListener('change', updateCcqUI));
    document.addEventListener('DOMContentLoaded', updateCcqUI);

    // Logo preview
    const logoInput = document.getElementById('logo');
    const logoPreview = document.getElementById('logoPreview');
    const logoImg = document.getElementById('logoImg');
    const logoClear = document.getElementById('logoClear');

    if (logoInput){
      logoInput.addEventListener('change', ()=>{
        const file = logoInput.files?.[0];
        if(file){
          const url = URL.createObjectURL(file);
          logoImg.src = url;
          remHidden(logoPreview);
        }else{
          addHidden(logoPreview);
          logoImg.removeAttribute('src');
        }
      });
    }
    if (logoClear){
      logoClear.addEventListener('click', ()=>{
        logoInput.value = '';
        logoImg.removeAttribute('src');
        addHidden(logoPreview);
      });
    }

    // Submit flow (Apps Script → Stripe)
    const form = document.getElementById('jobForm');
    const submitBtn = document.getElementById('submitBtn');

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();

      // Validate visible required fields only
      const requiredFields = [...form.querySelectorAll('[required]')]
        .filter(el => !isHidden(el) && !isHidden(el.closest('.section')) && !isHidden(el.closest('div')));
      for(const el of requiredFields){
        if(!String(el.value||'').trim()){
          alert('Veuillez remplir tous les champs requis (*)');
          el.focus(); return;
        }
      }

      // Honeypot
      const hp = form.querySelector('input[name="website_hp"]');
      if (hp && hp.value) { alert('Requête bloquée.'); return; }

      // Apply methods → CSV
      const methods = [...document.querySelectorAll('input[name="apply_methods"]:checked')].map(i=>i.value);
      const fd = new FormData(form);
      fd.append('Apply Methods', methods.join(', '));
      fd.append('action','create_session'); // serveur détermine le prix

      // Save for merci.html
      const plain = Object.fromEntries(fd.entries());
      sessionStorage.setItem('jobForm', JSON.stringify(plain));

      submitBtn.disabled = true;

      try{
        const res = await fetch(API, { method:'POST', body:fd, cache:'no-store' });
        if (!res.ok) throw new Error('API indisponible');
        const j = await res.json();
        if(j.ok && j.url){
          location.href = j.url; // → Stripe Checkout
        }else{
          alert('Erreur: ' + (j.error || 'création paiement'));
          submitBtn.disabled = false;
        }
      }catch(err){
        alert('Erreur réseau: ' + err.message);
        submitBtn.disabled = false;
      }
    });
  </script>
</body>
</html>


